name: AI reply to issue author (once)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  models: read
  contents: read

jobs:
  reply-to-issue-author:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare comment context
        id: prepare
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload || {};
            const comment = payload.comment || {};
            const issue = payload.issue || {};
            const commenter = (comment.user && comment.user.login) ? comment.user.login : '';
            const issueNumber = issue.number || (payload.issue ? payload.issue.number : undefined);
            const commentBody = comment.body || '';

            if (!issueNumber || !commenter) {
              core.info('Missing issue number or commenter; exiting');
              return { proceed: 'false' };
            }

            // Skip bot actors
            const actor = commenter;
            if (/\[bot\]$/.test(actor) || actor === 'github-actions[bot]') {
              core.info('Comment from bot; skipping');
              return { proceed: 'false' };
            }

            // Fetch issue data early to check assignees and author
            let issueData = null;
            try {
              const res = await github.rest.issues.get({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber });
              issueData = res && res.data ? res.data : null;
            } catch (e) {
              core.info('Failed to fetch issue data; continuing where possible');
            }

            // Exclude repo owner
            // const repoOwner = context.repo.owner;
            // if (commenter === repoOwner) {
            //  core.info('Commenter is repo owner; skipping AI reply');
            //  return { proceed: 'false' };
            // }

            // Only reply to the original issue author: skip if commenter is not the issue creator
            if (issueData && issueData.user && issueData.user.login && commenter !== issueData.user.login) {
              core.info('Commenter is not the issue author; skipping AI reply (we only reply to issue author)');
              return { proceed: 'false' };
            }

            // Exclude issue assignees/reviewers
            // if (issueData && Array.isArray(issueData.assignees) && issueData.assignees.some(a => a && a.login === commenter)) {
            //   core.info('Commenter is an assignee/reviewer for this issue; skipping AI reply');
            //   return { proceed: 'false' };
            // }

            // Exclude repo collaborators with elevated permissions (write/maintain/admin/triage)
            // try {
            //  const permRes = await github.rest.repos.getCollaboratorPermissionLevel({ owner: context.repo.owner, repo: context.repo.repo, username: commenter });
            //  const perm = permRes && permRes.data && permRes.data.permission ? permRes.data.permission : null;
            //  if (perm && perm !== 'read' && perm !== 'none') {
            //    core.info(`Commenter has repo permission ${perm}; skipping AI reply`);
            //    return { proceed: 'false' };
            //  }
            // } catch (e) {
            //   core.info('Could not determine collaborator permission (user may not be a collaborator)');
            // }

            // Count comments by this user on the issue (comments only)
            const { data: comments } = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber });
            const byUser = (comments || []).filter(c => c.user && c.user.login === commenter);

            // Also count the issue body as the user's first contribution if they are the issue author
            const issueAuthorIsUser = issueData && issueData.user && issueData.user.login === commenter;

            const initialCount = issueAuthorIsUser ? 1 : 0;
            const totalByUser = initialCount + (byUser.length || 0);
            core.info(`User ${commenter} has ${byUser.length} comments on issue #${issueNumber} (initialCount=${initialCount}, total=${totalByUser})`);

            // Only proceed if this is at least the user's third contribution (including the issue body if they authored it)
            if ((totalByUser || 0) < 3) {
              core.info('Not reached required contribution count yet; skipping AI reply');
              return { proceed: 'false' };
            }

            // Check for existing AI reply marker for this user
            const marker = `<!-- ai-replied-to-${commenter} -->`;
            const existingMarker = (comments || []).find(c => c.body && c.body.includes(marker));
            if (existingMarker) {
              core.info('AI already replied to this user on this issue; skipping');
              return { proceed: 'false' };
            }

            core.setOutput('issue_number', String(issueNumber));
            core.setOutput('commenter', commenter);
            core.setOutput('comment_body', commentBody);
            core.setOutput('proceed', 'true');
            return { issue_number: String(issueNumber), commenter, comment_body: commentBody, proceed: 'true' };

      - name: Run AI assessment on comment
        if: ${{ steps.prepare.outputs.proceed == 'true' }}
        id: ai_assess
        uses: github/ai-assessment-comment-labeler@v1.0.1
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          ai_review_label: 'copilot'
          issue_number: "${{ steps.prepare.outputs.issue_number }}"
          issue_body: "${{ steps.prepare.outputs.comment_body }}"
          prompts_directory: './prompts'
          labels_to_prompts_mapping: 'copilot,issue-review.with-context.prompt.yml'
          suppress_comments: 'true'
          suppress_labels: 'true'

      - name: Post AI reply comment (once)
        if: ${{ steps.prepare.outputs.proceed == 'true' }}
        uses: actions/github-script@v7
        env:
          AI_ASSESSMENTS: ${{ steps.ai_assess.outputs.ai_assessments }}
          ISSUE_NUMBER: ${{ steps.prepare.outputs.issue_number }}
          COMMENTER: ${{ steps.prepare.outputs.commenter }}
        with:
          script: |
            const assessmentsRaw = process.env.AI_ASSESSMENTS || '';
            let assessments = [];
            try {
              let cleaned = assessmentsRaw;
              if (typeof cleaned === 'string' && cleaned.startsWith('"') && cleaned.endsWith('"')) {
                cleaned = cleaned.slice(1, -1).replace(/\\"/g, '"').replace(/\\n/g, '\n');
              }
              assessments = JSON.parse(cleaned || '[]');
            } catch (e) {
              core.info('No valid ai_assessments JSON found or failed to parse.');
            }

            const issueNumber = Number(process.env.ISSUE_NUMBER || 0);
            const commenter = process.env.COMMENTER || '';
            const marker = `<!-- ai-replied-to-${commenter} -->`;

            let body = `${marker}\n@${commenter} ` + '\n\n';
            if (!assessments.length) {
              body += '_No AI assessment produced._\n\n';
            } else {
              // Combine assessment responses
              body += assessments.map(a => a.response || '').join('\n\n') + '\n\n';
            }

            body += '---\n';
            body += 'If you need more help, reply here and a maintainer will follow up.';

            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber, body });
            core.info('Posted AI reply comment and added marker for ' + commenter);
