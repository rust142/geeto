name: AI reply once on user's third comment

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  models: read
  contents: read

jobs:
  reply-on-third-comment:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare comment context
        id: prepare
        uses: actions/github-script@v7
        with:
          script: |
            const payload = context.payload || {};
            const comment = payload.comment || {};
            const issue = payload.issue || {};
            const commenter = (comment.user && comment.user.login) ? comment.user.login : '';
            const issueNumber = issue.number || (payload.issue ? payload.issue.number : undefined);
            const commentBody = comment.body || '';

            if (!issueNumber || !commenter) {
              core.info('Missing issue number or commenter; exiting');
              return { proceed: 'false' };
            }

            // Skip bot actors
            const actor = commenter;
            if (/\[bot\]$/.test(actor) || actor === 'github-actions[bot]') {
              core.info('Comment from bot; skipping');
              return { proceed: 'false' };
            }

            // Count comments by this user on the issue
            const { data: comments } = await github.rest.issues.listComments({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber });
            const byUser = (comments || []).filter(c => c.user && c.user.login === commenter);
            core.info(`User ${commenter} has ${byUser.length} comments on issue #${issueNumber}`);

            // Only proceed if this is at least the user's third comment
            if ((byUser.length || 0) < 3) {
              core.info('Not the third comment yet; skipping AI reply');
              return { proceed: 'false' };
            }

            // Check for existing AI reply marker for this user
            const marker = `<!-- ai-replied-to-${commenter} -->`;
            const existingMarker = (comments || []).find(c => c.body && c.body.includes(marker));
            if (existingMarker) {
              core.info('AI already replied to this user on this issue; skipping');
              return { proceed: 'false' };
            }

            core.setOutput('issue_number', String(issueNumber));
            core.setOutput('commenter', commenter);
            core.setOutput('comment_body', commentBody);
            core.setOutput('proceed', 'true');
            return { issue_number: String(issueNumber), commenter, comment_body: commentBody, proceed: 'true' };

      - name: Run AI assessment on comment
        if: ${{ steps.prepare.outputs.proceed == 'true' }}
        id: ai_assess
        uses: github/ai-assessment-comment-labeler@v1.0.1
        with:
          token: "${{ secrets.GITHUB_TOKEN }}"
          ai_review_label: 'copilot'
          issue_number: "${{ steps.prepare.outputs.issue_number }}"
          issue_body: "${{ steps.prepare.outputs.comment_body }}"
          prompts_directory: './prompts'
          labels_to_prompts_mapping: 'copilot,issue-review.with-context.prompt.yml'
          suppress_comments: 'true'
          suppress_labels: 'true'

      - name: Post AI reply comment (once)
        if: ${{ steps.prepare.outputs.proceed == 'true' }}
        uses: actions/github-script@v7
        env:
          AI_ASSESSMENTS: ${{ steps.ai_assess.outputs.ai_assessments }}
          ISSUE_NUMBER: ${{ steps.prepare.outputs.issue_number }}
          COMMENTER: ${{ steps.prepare.outputs.commenter }}
        with:
          script: |
            const assessmentsRaw = process.env.AI_ASSESSMENTS || '';
            let assessments = [];
            try {
              let cleaned = assessmentsRaw;
              if (typeof cleaned === 'string' && cleaned.startsWith('"') && cleaned.endsWith('"')) {
                cleaned = cleaned.slice(1, -1).replace(/\\"/g, '"').replace(/\\n/g, '\n');
              }
              assessments = JSON.parse(cleaned || '[]');
            } catch (e) {
              core.info('No valid ai_assessments JSON found or failed to parse.');
            }

            const issueNumber = Number(process.env.ISSUE_NUMBER || 0);
            const commenter = process.env.COMMENTER || '';
            const marker = `<!-- ai-replied-to-${commenter} -->`;

            let body = `${marker}\n@${commenter} ` + '\n\n';
            if (!assessments.length) {
              body += '_No AI assessment produced._\n\n';
            } else {
              // Combine assessment responses
              body += assessments.map(a => a.response || '').join('\n\n') + '\n\n';
            }

            body += '---\n';
            body += 'If you need more help, reply here and a maintainer will follow up.';

            await github.rest.issues.createComment({ owner: context.repo.owner, repo: context.repo.repo, issue_number: issueNumber, body });
            core.info('Posted AI reply comment and added marker for ' + commenter);
