name: Build & Publish Binaries

on:
  release:
    types: [published]

permissions:
  contents: write

jobs:
  build-binaries:
    name: Build ${{ matrix.target }}
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - target: linux-x64
            os: ubuntu-latest
            binary: geeto-linux
            script: geeto:build:linux
          - target: linux-arm64
            os: ubuntu-latest
            binary: geeto-linux-arm64
            script: geeto:build:linux:arm64
          - target: mac-x64
            os: macos-latest
            binary: geeto-mac
            script: geeto:build:mac
          - target: mac-arm64
            os: macos-latest
            binary: geeto-mac-arm64
            script: geeto:build:mac:arm64
          - target: windows-x64
            os: ubuntu-latest
            binary: geeto-windows.exe
            script: geeto:build:windows

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build TypeScript
        run: bun run build

      - name: Compile binary
        run: bun run ${{ matrix.script }}

      - name: Upload binary to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: gh release upload "${{ github.event.release.tag_name }}" "${{ matrix.binary }}" --clobber

  build-deb:
    name: Build .deb packages
    runs-on: ubuntu-latest
    needs: build-binaries

    steps:
      - uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install

      - name: Build TypeScript
        run: bun run build

      - name: Build Linux binaries
        run: |
          bun run geeto:build:linux
          bun run geeto:build:linux:arm64

      - name: Build .deb (amd64)
        run: bash scripts/build-deb.sh "${GITHUB_REF_NAME#v}" amd64

      - name: Build .deb (arm64)
        run: bash scripts/build-deb.sh "${GITHUB_REF_NAME#v}" arm64

      - name: Upload .deb packages to release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"
          gh release upload "${{ github.event.release.tag_name }}" \
            "dist/geeto_${VERSION}_amd64.deb" \
            "dist/geeto_${VERSION}_arm64.deb" \
            --clobber

  update-homebrew:
    name: Update Homebrew formula
    runs-on: ubuntu-latest
    needs: build-binaries

    steps:
      - uses: actions/checkout@v4

      - name: Download binaries and compute SHA256
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          BASE="https://github.com/rust142/geeto/releases/download/${TAG}"

          mkdir -p /tmp/bins
          for bin in geeto-mac geeto-mac-arm64 geeto-linux geeto-linux-arm64; do
            echo "Downloading ${bin}..."
            gh release download "${TAG}" -p "${bin}" -D /tmp/bins
          done

          MAC_X64_SHA=$(sha256sum /tmp/bins/geeto-mac | awk '{print $1}')
          MAC_ARM_SHA=$(sha256sum /tmp/bins/geeto-mac-arm64 | awk '{print $1}')
          LINUX_X64_SHA=$(sha256sum /tmp/bins/geeto-linux | awk '{print $1}')
          LINUX_ARM_SHA=$(sha256sum /tmp/bins/geeto-linux-arm64 | awk '{print $1}')

          echo "MAC_X64_SHA=${MAC_X64_SHA}" >> "$GITHUB_ENV"
          echo "MAC_ARM_SHA=${MAC_ARM_SHA}" >> "$GITHUB_ENV"
          echo "LINUX_X64_SHA=${LINUX_X64_SHA}" >> "$GITHUB_ENV"
          echo "LINUX_ARM_SHA=${LINUX_ARM_SHA}" >> "$GITHUB_ENV"
          echo "VERSION=${VERSION}" >> "$GITHUB_ENV"

      - name: Update formula
        run: |
          mkdir -p Formula
          cat > Formula/geeto.rb <<EOF
          # typed: false
          # frozen_string_literal: true

          class Geeto < Formula
            desc "AI-powered Git workflow automation CLI"
            homepage "https://github.com/rust142/geeto"
            version "${VERSION}"
            license "MIT"

            on_macos do
              if Hardware::CPU.intel?
                url "https://github.com/rust142/geeto/releases/download/v${VERSION}/geeto-mac"
                sha256 "${MAC_X64_SHA}"

                def install
                  bin.install "geeto-mac" => "geeto"
                end
              elsif Hardware::CPU.arm?
                url "https://github.com/rust142/geeto/releases/download/v${VERSION}/geeto-mac-arm64"
                sha256 "${MAC_ARM_SHA}"

                def install
                  bin.install "geeto-mac-arm64" => "geeto"
                end
              end
            end

            on_linux do
              if Hardware::CPU.intel?
                url "https://github.com/rust142/geeto/releases/download/v${VERSION}/geeto-linux"
                sha256 "${LINUX_X64_SHA}"

                def install
                  bin.install "geeto-linux" => "geeto"
                end
              elsif Hardware::CPU.arm?
                url "https://github.com/rust142/geeto/releases/download/v${VERSION}/geeto-linux-arm64"
                sha256 "${LINUX_ARM_SHA}"

                def install
                  bin.install "geeto-linux-arm64" => "geeto"
                end
              end
            end

            test do
              assert_match "Geeto v\#{version}", shell_output("\#{bin}/geeto --version")
            end
          end
          EOF

          # Remove leading whitespace from heredoc indentation
          sed -i 's/^          //' Formula/geeto.rb

      - name: Commit and push formula update
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Formula/geeto.rb
          git commit -m "chore(brew): update formula to v${VERSION}" --no-verify || true
          git push
