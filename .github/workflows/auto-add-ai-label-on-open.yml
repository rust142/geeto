name: Auto-add AI Review Label (Ensure + Apply)

# This single workflow ensures the label exists and adds it to new issues, and then
# runs the AI assessment immediately (so a separate 'issues.labeled' trigger is not required).
on:
  issues:
    types: [opened]
  workflow_dispatch: {}
  push:
    branches: [ main, develop ]

permissions:
  issues: write
  models: read
  contents: read

jobs:
  add-label:
    runs-on: ubuntu-latest

    steps:
      - name: Ensure label exists and add to issue (if any)
        uses: actions/github-script@v7
        with:
          script: |
            const labelName = 'request ai review';
            const color = '6f42c1';
            const description = 'Trigger AI Issue Assessment action';

            // Create label if it doesn't exist
            try {
              await github.rest.issues.getLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
              });
            } catch (err) {
              await github.rest.issues.createLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                name: labelName,
                color,
                description,
              });
            }

            // If triggered by an issue event, add the label to the issue
            if (context.payload.issue && context.payload.action === 'opened') {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                labels: [labelName],
              });
            } else {
              core.info('No issue to label; run used to ensure label exists.');
            }

      - name: Run AI assessment (for newly opened issue)
        if: ${{ github.event_name == 'issues' && github.event.action == 'opened' }}
        id: ai-assessment
        uses: github/ai-assessment-comment-labeler@v1.0.1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          ai_review_label: 'request ai review'
          issue_number: ${{ github.event.issue.number }}
          issue_body: ${{ github.event.issue.body }}
          repo_name: ${{ github.event.repository.name }}
          prompts_directory: './prompts'
          labels_to_prompts_mapping: 'bug,bug-review.prompt.yml'
