name: Release

on:
  push:
    branches: [ main ]

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Node.js
      uses: actions/setup-node@v6
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'

    - name: Setup GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh

    # Note: Do not run `gh auth login` in Actions while GITHUB_TOKEN is present
    # Instead, provide the token via the GH_TOKEN env var to the step that needs gh.

    - name: Install dependencies
      run: bun install

    - name: Setup Husky
      run: bun run prepare

    - name: Determine release type from PR labels
      id: release-type
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # Get the last merged PR (gh will read token from GH_TOKEN)
        PR_DATA=$(gh pr list --state merged --limit 1 --json labels,title,headRefName --jq '.[0]')
        if [ -z "$PR_DATA" ]; then
          echo "No merged PR found, defaulting to patch"
          echo "RELEASE_TYPE=patch" >> $GITHUB_ENV
          exit 0
        fi

        LABELS=$(echo $PR_DATA | jq -r '.labels[].name')

        if echo "$LABELS" | grep -q "enhancement\|feat"; then
          RELEASE_TYPE="minor"
        elif echo "$LABELS" | grep -q "bug\|fix"; then
          RELEASE_TYPE="patch"
        elif echo "$LABELS" | grep -q "breaking\|major"; then
          RELEASE_TYPE="major"
        else
          RELEASE_TYPE="patch"
        fi

        echo "Detected release type: $RELEASE_TYPE"
        echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_ENV

    - name: Run release
      run: bun run release:$RELEASE_TYPE --ci
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
