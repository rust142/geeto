name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ develop ]

jobs:
  quality-checks:
    name: Quality Checks
    runs-on: ubuntu-latest

    strategy:
      matrix:
        node-version: [18.x, 20.x]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Node.js ${{ matrix.node-version }}
      uses: actions/setup-node@v4
      with:
        node-version: ${{ matrix.node-version }}
        cache: 'npm'

    - name: Install dependencies
      run: bun install

    - name: Setup Husky
      run: bun run prepare

    - name: Check code formatting
      run: bun run format:check

    - name: Run ESLint
      run: bun run lint

    - name: Run Markdown linting
      run: bun run lint:md

    - name: Run TypeScript type checking
      run: bun run typecheck

    - name: Build project
      run: bun run build

    - name: Build release binaries
      run: bun run geeto:build:all

    - name: Show build artifacts
      run: ls -la

    - name: Upload build artifacts
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: geeto-binaries-${{ matrix.node-version }}
        path: |
          geeto
          geeto-linux
          geeto-linux-arm64
          geeto-windows.exe
          geeto-mac
          geeto-mac-arm64
        retention-days: 1
        if-no-files-found: warn

  cross-platform-test:
    name: Cross Platform Test
    runs-on: ${{ matrix.os }}
    needs: quality-checks
    strategy:
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]

    steps:
    - name: Download build artifacts
      uses: actions/download-artifact@v4
      with:
        name: geeto-binaries-20.x
        path: .

    - name: Make binary executable (Linux/macOS)
      if: runner.os != 'Windows'
      run: |
        chmod +x geeto-linux
        chmod +x geeto-linux-arm
        chmod +x geeto-mac
        chmod +x geeto-mac-arm

    - name: Test Linux binary
      if: runner.os == 'Linux'
      run: ./geeto-linux --help | head -10

    - name: Test Linux ARM binary
      if: runner.os == 'Linux'
      run: ./geeto-linux-arm --help | head -10

    - name: Test Windows binary
      if: runner.os == 'Windows'
      run: .\geeto-windows.exe --help | Select-Object -First 10

    - name: Test macOS binary
      if: runner.os == 'macOS'
      run: ./geeto-mac --help | head -10

    - name: Test macOS ARM binary
      if: runner.os == 'macOS'
      run: ./geeto-mac-arm --help | head -10

  commitlint:
    name: Commit Message Lint
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Setup Husky
      run: bun run prepare

    - name: Validate current commit (last commit) with commitlint
      if: github.event_name == 'push'
      run: bun run commitlint --from HEAD~1 --to HEAD --verbose

    - name: Validate PR commits with commitlint
      if: github.event_name == 'pull_request'
      run: bun run commitlint --from ${{ github.event.pull_request.head.sha }}~${{ github.event.pull_request.commits }} --to ${{ github.event.pull_request.head.sha }} --verbose

  auto-label:
    name: Auto Label PR
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Auto label PR based on conventional commits
      uses: bcoe/conventional-release-labels@v1
      with:
        type_labels: |
          {
            "feat": "enhancement",
            "fix": "bug",
            "docs": "documentation",
            "style": "style",
            "refactor": "refactor",
            "perf": "performance",
            "test": "test",
            "chore": "chore"
          }
        ignored_types: |
          []
        token: ${{ secrets.GITHUB_TOKEN }}

  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Run security audit
      run: bun audit

    - name: Run Snyk security scan (if available)
      continue-on-error: true
      run: |
        if command -v snyk &> /dev/null; then
          snyk test --severity-threshold=high
        else
          echo "Snyk not available, skipping security scan"
        fi

  codeql-analysis:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ 'javascript' ]

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Initialize CodeQL
      uses: github/codeql-action/init@v3
      with:
        languages: ${{ matrix.language }}
        queries: security-and-quality

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Install dependencies
      run: bun install

    - name: Build project
      run: bun run build

    - name: Perform CodeQL Analysis
      uses: github/codeql-action/analyze@v3

  release:
    name: Release
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    needs: [quality-checks, commitlint, security-scan, codeql-analysis]

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: Setup Bun
      uses: oven-sh/setup-bun@v1
      with:
        bun-version: latest

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'
        registry-url: 'https://registry.npmjs.org'

    - name: Setup GitHub CLI
      run: |
        curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg | sudo dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg
        echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" | sudo tee /etc/apt/sources.list.d/github-cli.list > /dev/null
        sudo apt update
        sudo apt install gh

    - name: Install dependencies
      run: bun install

    - name: Setup Husky
      run: bun run prepare

    - name: Determine release type from PR labels
      id: release-type
      run: |
        # Get the last merged PR
        PR_DATA=$(gh pr list --merged --limit 1 --json labels,title,headRefName --jq '.[0]')
        if [ -z "$PR_DATA" ]; then
          echo "No merged PR found, defaulting to patch"
          echo "RELEASE_TYPE=patch" >> $GITHUB_ENV
          exit 0
        fi

        LABELS=$(echo $PR_DATA | jq -r '.labels[].name')

        if echo "$LABELS" | grep -q "enhancement\|feat"; then
          RELEASE_TYPE="minor"
        elif echo "$LABELS" | grep -q "bug\|fix"; then
          RELEASE_TYPE="patch"
        elif echo "$LABELS" | grep -q "breaking\|major"; then
          RELEASE_TYPE="major"
        else
          RELEASE_TYPE="patch"
        fi

        echo "Detected release type: $RELEASE_TYPE"
        echo "RELEASE_TYPE=$RELEASE_TYPE" >> $GITHUB_ENV
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Run release
      run: bun run release:$RELEASE_TYPE --ci
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
